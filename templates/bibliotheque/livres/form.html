{% extends 'bibliotheque/base.html' %}
{% load static %}

{% block title %}{{ action|default:"Ajouter" }} un livre ‚Äî Biblioth√®que{% endblock %}

{% block extra_css %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap');

  :root {
    --ink: #1a1209;
    --parchment: #f5f0e8;
    --sepia: #2c3e6b;
    --sepia-light: #6b8cba;
    --sepia-pale: #e0e8f4;
    --accent: #b04030;
    --border: #d4c4a8;
    --shadow: rgba(26, 18, 9, 0.12);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background-color: var(--parchment);
    background-image:
      radial-gradient(ellipse at 20% 50%, rgba(44,62,107,.05) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 20%, rgba(176,64,48,.04) 0%, transparent 50%);
    font-family: 'Lato', sans-serif;
    color: var(--ink);
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .page-header {
    background: var(--ink);
    padding: 2.5rem 3rem;
    position: relative;
    overflow: hidden;
  }
  .page-header::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--sepia-light), var(--accent), var(--sepia-light), transparent);
  }
  .breadcrumb-top {
    font-size: .7rem;
    letter-spacing: .15em;
    text-transform: uppercase;
    color: var(--sepia-light);
    margin-bottom: .6rem;
  }
  .breadcrumb-top a { color: var(--sepia-light); text-decoration: none; }
  .breadcrumb-top a:hover { color: #fff; }
  .page-header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 2.1rem;
    color: #fff;
    font-weight: 400;
    font-style: italic;
  }
  .page-header h1 span { color: var(--sepia-light); font-style: normal; }
  .page-header p { font-size: .83rem; color: rgba(255,255,255,.4); margin-top: .4rem; }

  /* ‚îÄ‚îÄ Container ‚îÄ‚îÄ */
  .form-container {
    max-width: 980px;
    margin: 2.5rem auto;
    padding: 0 1.5rem 4rem;
  }

  /* ‚îÄ‚îÄ Conseil banner ‚îÄ‚îÄ */
  .conseil-banner {
    display: flex;
    align-items: flex-start;
    gap: .75rem;
    background: #f0f5ff;
    border-left: 3px solid var(--sepia-light);
    border-radius: 1px;
    padding: .85rem 1.2rem;
    margin-bottom: 1.8rem;
    font-size: .82rem;
    color: var(--sepia);
  }

  /* ‚îÄ‚îÄ Section card ‚îÄ‚îÄ */
  .form-section {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 2px;
    box-shadow: 0 4px 20px var(--shadow);
    overflow: hidden;
    margin-bottom: 1.5rem;
    opacity: 0;
    transform: translateY(14px);
    animation: fadeUp .4s ease forwards;
  }
  @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

  .section-header {
    display: flex;
    align-items: center;
    gap: .8rem;
    padding: 1.2rem 2rem;
    border-bottom: 1px solid var(--sepia-pale);
    background: var(--parchment);
  }
  .section-num {
    width: 28px; height: 28px;
    border-radius: 50%;
    background: var(--ink);
    color: var(--sepia-light);
    font-family: 'Playfair Display', serif;
    font-size: .8rem;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .section-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    font-weight: 400;
    color: var(--ink);
  }
  .section-header p { font-size: .73rem; color: var(--sepia); margin-top: .1rem; }

  .section-body { padding: 1.8rem 2rem; }

  /* ‚îÄ‚îÄ Grids ‚îÄ‚îÄ */
  .fields-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.3rem 1.8rem;
  }
  .fields-grid .full { grid-column: 1 / -1; }
  .fields-grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1.3rem 1.8rem;
  }

  /* ‚îÄ‚îÄ Field group ‚îÄ‚îÄ */
  .field-group { display: flex; flex-direction: column; gap: .38rem; }

  .field-group label {
    font-size: .68rem;
    font-weight: 700;
    letter-spacing: .1em;
    text-transform: uppercase;
    color: var(--sepia);
  }
  .field-group label .req { color: var(--accent); margin-left: 2px; }

  /* ‚îÄ‚îÄ Tous les champs texte/select/textarea ‚îÄ‚îÄ */
  .field-group input[type="text"],
  .field-group input[type="number"],
  .field-group input[type="email"],
  .field-group input[type="url"],
  .field-group select,
  .field-group textarea {
    border: 1px solid var(--border);
    border-radius: 1px;
    padding: .68rem 1rem;
    font-family: 'Lato', sans-serif;
    font-size: .9rem;
    color: var(--ink);
    background: #fdfcfa;
    outline: none;
    width: 100%;
    transition: border-color .2s, box-shadow .2s, background .2s;
    appearance: none;
    -webkit-appearance: none;
  }
  .field-group input[type="text"]:focus,
  .field-group input[type="number"]:focus,
  .field-group select:focus,
  .field-group textarea:focus {
    border-color: var(--sepia);
    background: #fff;
    box-shadow: 0 0 0 3px rgba(44,62,107,.12);
  }
  .field-group input.error-field,
  .field-group select.error-field,
  .field-group textarea.error-field {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(176,64,48,.1);
  }

  /* Select arrow */
  .field-group select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b8cba' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right .9rem center;
    padding-right: 2.5rem;
    cursor: pointer;
  }

  /* SelectMultiple */
  .field-group select[multiple] {
    background-image: none;
    padding: .5rem .8rem;
    min-height: 130px;
  }
  .field-group select[multiple] option {
    padding: .3rem .5rem;
    border-radius: 1px;
  }
  .field-group select[multiple] option:checked {
    background: var(--sepia);
    color: #fff;
  }

  /* Textarea */
  .field-group textarea {
    resize: vertical;
    min-height: 110px;
    line-height: 1.65;
  }

  /* File input */
  .field-group input[type="file"] {
    border: none;
    padding: 0;
    background: transparent;
    font-size: .82rem;
    color: var(--sepia);
    width: 100%;
    cursor: pointer;
  }

  .field-group .help  { font-size: .72rem; color: var(--sepia-light); font-style: italic; }
  .field-group .error { font-size: .72rem; color: var(--accent); margin-top: .1rem; }

  /* Compteur */
  .char-counter {
    font-size: .68rem;
    color: var(--sepia-light);
    text-align: right;
    font-style: italic;
  }
  .char-counter.warn { color: var(--accent); }

  /* ‚îÄ‚îÄ Checkbox ‚îÄ‚îÄ */
  .check-row {
    display: flex;
    align-items: flex-start;
    gap: .75rem;
    padding: .5rem 0;
  }
  .check-row input[type="checkbox"] {
    width: 18px; height: 18px;
    border: 2px solid var(--border);
    border-radius: 2px;
    appearance: none;
    -webkit-appearance: none;
    background: #fdfcfa;
    cursor: pointer;
    flex-shrink: 0;
    margin-top: 2px;
    transition: all .15s;
    position: relative;
  }
  .check-row input[type="checkbox"]:checked {
    background: var(--ink);
    border-color: var(--ink);
  }
  .check-row input[type="checkbox"]:checked::after {
    content: '‚úì';
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    color: #fff; font-size: .7rem; font-weight: 700;
  }
  .check-label strong { font-size: .85rem; font-weight: 700; color: var(--ink); display: block; }
  .check-label span   { font-size: .73rem; color: var(--sepia); font-style: italic; }

  /* ‚îÄ‚îÄ Zone upload ‚îÄ‚îÄ */
  .upload-area {
    border: 2px dashed var(--border);
    border-radius: 1px;
    padding: 1.4rem;
    text-align: center;
    background: #fdfcfa;
    transition: border-color .2s, background .2s;
  }
  .upload-area:hover { border-color: var(--sepia-light); background: var(--sepia-pale); }
  .upload-area .up-icon { font-size: 1.8rem; opacity: .3; margin-bottom: .4rem; }
  .upload-area p { font-size: .77rem; color: var(--sepia); font-style: italic; margin-bottom: .6rem; }

  .cover-preview { display: none; margin-top: .75rem; text-align: center; }
  .cover-preview img {
    max-width: 120px;
    border-radius: 1px;
    box-shadow: 3px 3px 12px var(--shadow);
  }
  .cover-preview p { font-size: .7rem; color: var(--sepia-light); font-style: italic; margin-top: .35rem; }

  .current-cover { margin-top: .75rem; text-align: center; }
  .current-cover img {
    max-width: 100px;
    border-radius: 1px;
    box-shadow: 3px 3px 10px var(--shadow);
  }
  .current-cover p { font-size: .7rem; color: var(--sepia-light); font-style: italic; margin-top: .3rem; }

  .pdf-existing {
    margin-top: .6rem;
    display: flex;
    align-items: center;
    gap: .6rem;
    padding: .6rem .9rem;
    background: var(--parchment);
    border: 1px solid var(--border);
    border-radius: 1px;
    font-size: .8rem;
    color: var(--sepia);
  }
  .pdf-existing a { color: var(--accent); font-weight: 700; text-decoration: none; }
  .pdf-existing a:hover { text-decoration: underline; }

  /* ‚îÄ‚îÄ Erreurs globales ‚îÄ‚îÄ */
  .alert-errors {
    margin-bottom: 1.5rem;
    padding: 1rem 1.2rem;
    background: #fef5f4;
    border-left: 3px solid var(--accent);
    border-radius: 1px;
    font-size: .85rem;
    color: var(--accent);
  }

  /* ‚îÄ‚îÄ Actions ‚îÄ‚îÄ */
  .form-actions {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 2px;
    box-shadow: 0 4px 20px var(--shadow);
    padding: 1.4rem 2rem;
    display: flex;
    align-items: center;
    gap: .75rem;
    flex-wrap: wrap;
  }
  .btn {
    display: inline-flex;
    align-items: center;
    gap: .45rem;
    padding: .72rem 1.6rem;
    font-family: 'Lato', sans-serif;
    font-size: .78rem;
    font-weight: 700;
    letter-spacing: .1em;
    text-transform: uppercase;
    border: 1px solid transparent;
    border-radius: 1px;
    cursor: pointer;
    text-decoration: none;
    transition: all .2s;
    white-space: nowrap;
  }
  .btn-primary { background: var(--ink); color: #fff; border-color: var(--ink); }
  .btn-primary:hover {
    background: var(--accent); border-color: var(--accent);
    transform: translateY(-1px); box-shadow: 0 4px 16px rgba(176,64,48,.3);
    color: #fff;
  }
  .btn-secondary { background: transparent; color: var(--sepia); border-color: var(--border); }
  .btn-secondary:hover { border-color: var(--sepia); color: var(--ink); }
  .btn-view { background: var(--sepia-pale); color: var(--sepia); border-color: var(--sepia-light); margin-left: auto; }
  .btn-view:hover { background: var(--sepia); color: #fff; }

  .ornament {
    text-align: center;
    padding: 1rem 0 .5rem;
    color: var(--border);
    font-size: 1rem;
    letter-spacing: .5em;
  }

  kbd {
    background: var(--ink); color: var(--sepia-light);
    padding: .1rem .4rem; border-radius: 2px;
    font-size: .73rem; font-family: monospace;
  }

  @media (max-width: 640px) {
    .fields-grid, .fields-grid-3 { grid-template-columns: 1fr; }
    .section-body { padding: 1.2rem; }
    .page-header { padding: 1.5rem; }
    .form-actions { flex-direction: column; }
    .btn-view { margin-left: 0; }
  }
</style>
{% endblock %}

{% block content %}

<!-- Header -->
<div class="page-header">
  <div class="breadcrumb-top">
    <a href="{% url 'home' %}">Accueil</a> &nbsp;‚Ä∫&nbsp;
    <a href="{% url 'livre_list' %}">Livres</a> &nbsp;‚Ä∫&nbsp;
    {{ action|default:"Ajouter" }}
  </div>
  <h1>
    {% if action == 'Modifier' %}
      Modifier <span>¬´ {{ livre.titre|truncatewords:5 }} ¬ª</span>
    {% else %}
      <span>Enregistrer</span> un nouveau livre
    {% endif %}
  </h1>
  <p>
    {% if action == 'Modifier' %}Mettez √† jour les informations du livre dans le catalogue.
    {% else %}Remplissez le formulaire pour ajouter un livre au catalogue.{% endif %}
  </p>
</div>

<div class="form-container">

  <div class="conseil-banner">
    ‚Ñπ &nbsp; Les champs marqu√©s d'un ast√©risque (<strong style="color:var(--accent)">*</strong>) sont obligatoires.
  </div>

  <form method="post" enctype="multipart/form-data" id="livreForm" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
    <div class="alert-errors">
      {% for e in form.non_field_errors %}{{ e }}{% endfor %}
    </div>
    {% endif %}

    <!-- ‚ë† Informations de base -->
    <div class="form-section" style="animation-delay: 0ms">
      <div class="section-header">
        <div class="section-num">I</div>
        <div>
          <h2>Informations de base</h2>
          <p>ISBN, langue, √©tat et titre</p>
        </div>
      </div>
      <div class="section-body">

        <div class="fields-grid-3" style="margin-bottom: 1.3rem">
          <div class="field-group">
            <label for="{{ form.isbn.id_for_label }}">ISBN <span class="req">*</span></label>
            {{ form.isbn }}
            <span class="help">{{ form.isbn.help_text }}</span>
            {% if form.isbn.errors %}<span class="error">{{ form.isbn.errors|join:", " }}</span>{% endif %}
          </div>

          <div class="field-group">
            <label for="{{ form.langue.id_for_label }}">Langue <span class="req">*</span></label>
            {{ form.langue }}
            {% if form.langue.errors %}<span class="error">{{ form.langue.errors|join:", " }}</span>{% endif %}
          </div>

          <div class="field-group">
            <label for="{{ form.etat.id_for_label }}">√âtat du livre <span class="req">*</span></label>
            {{ form.etat }}
            {% if form.etat.errors %}<span class="error">{{ form.etat.errors|join:", " }}</span>{% endif %}
          </div>
        </div>

        <div class="fields-grid">
          <div class="field-group full">
            <label for="{{ form.titre.id_for_label }}">Titre du livre <span class="req">*</span></label>
            {{ form.titre }}
            <div class="char-counter" id="titreCounter">0 / 300 caract√®res</div>
            {% if form.titre.errors %}<span class="error">{{ form.titre.errors|join:", " }}</span>{% endif %}
          </div>

          <div class="field-group full">
            <label for="{{ form.sous_titre.id_for_label }}">Sous-titre</label>
            {{ form.sous_titre }}
            <span class="help">Optionnel</span>
            {% if form.sous_titre.errors %}<span class="error">{{ form.sous_titre.errors|join:", " }}</span>{% endif %}
          </div>
        </div>

      </div>
    </div>

    <!-- ‚ë° Auteurs & Publication -->
    <div class="form-section" style="animation-delay: 80ms">
      <div class="section-header">
        <div class="section-num">II</div>
        <div>
          <h2>Auteurs &amp; Publication</h2>
          <p>Auteurs, √©diteur et ann√©e</p>
        </div>
      </div>
      <div class="section-body">
        <div class="fields-grid">

          <div class="field-group full">
            <label for="{{ form.auteurs.id_for_label }}">Auteur(s) <span class="req">*</span></label>
            {{ form.auteurs }}
            <span class="help">{{ form.auteurs.help_text }}</span>
            {% if form.auteurs.errors %}<span class="error">{{ form.auteurs.errors|join:", " }}</span>{% endif %}
          </div>

          <div class="field-group">
            <label for="{{ form.editeur.id_for_label }}">√âditeur <span class="req">*</span></label>
            {{ form.editeur }}
            {% if form.editeur.errors %}<span class="error">{{ form.editeur.errors|join:", " }}</span>{% endif %}
          </div>

          <div class="field-group">
            <label for="{{ form.annee_publication.id_for_label }}">Ann√©e de publication <span class="req">*</span></label>
            {{ form.annee_publication }}
            {% if form.annee_publication.errors %}<span class="error">{{ form.annee_publication.errors|join:", " }}</span>{% endif %}
          </div>

        </div>
      </div>
    </div>

    <!-- ‚ë¢ Cat√©gorisation -->
    <div class="form-section" style="animation-delay: 160ms">
      <div class="section-header">
        <div class="section-num">III</div>
        <div>
          <h2>Cat√©gorisation</h2>
          <p>Genre, nombre de pages et r√©sum√©</p>
        </div>
      </div>
      <div class="section-body">
        <div class="fields-grid">

          <div class="field-group">
            <label for="{{ form.categorie.id_for_label }}">Cat√©gorie <span class="req">*</span></label>
            {{ form.categorie }}
            {% if form.categorie.errors %}<span class="error">{{ form.categorie.errors|join:", " }}</span>{% endif %}
          </div>

          <div class="field-group">
            <label for="{{ form.nombre_pages.id_for_label }}">Nombre de pages <span class="req">*</span></label>
            {{ form.nombre_pages }}
            {% if form.nombre_pages.errors %}<span class="error">{{ form.nombre_pages.errors|join:", " }}</span>{% endif %}
          </div>

          <div class="field-group full">
            <label for="{{ form.resume.id_for_label }}">R√©sum√©</label>
            {{ form.resume }}
            <div class="char-counter" id="resumeCounter">0 caract√®res</div>
            {% if form.resume.errors %}<span class="error">{{ form.resume.errors|join:", " }}</span>{% endif %}
          </div>

        </div>
      </div>
    </div>

    <!-- ‚ë£ Gestion des exemplaires -->
    <div class="form-section" style="animation-delay: 240ms">
      <div class="section-header">
        <div class="section-num">IV</div>
        <div>
          <h2>Gestion des exemplaires</h2>
          <p>Stock, emplacement et disponibilit√©</p>
        </div>
      </div>
      <div class="section-body">
        <div class="fields-grid-3">

          <div class="field-group">
            <label for="{{ form.nombre_exemplaires.id_for_label }}">Exemplaires <span class="req">*</span></label>
            {{ form.nombre_exemplaires }}
            <span class="help">{{ form.nombre_exemplaires.help_text }}</span>
            {% if form.nombre_exemplaires.errors %}<span class="error">{{ form.nombre_exemplaires.errors|join:", " }}</span>{% endif %}
          </div>

          <div class="field-group">
            <label for="{{ form.emplacement.id_for_label }}">Emplacement</label>
            {{ form.emplacement }}
            <span class="help">{{ form.emplacement.help_text }}</span>
            {% if form.emplacement.errors %}<span class="error">{{ form.emplacement.errors|join:", " }}</span>{% endif %}
          </div>

          <div class="field-group">
            <label>Statut</label>
            <div class="check-row" style="margin-top: .3rem">
              {{ form.disponible }}
              <div class="check-label">
                <strong>Disponible √† l'emprunt</strong>
                <span>{{ form.disponible.help_text }}</span>
              </div>
            </div>
            {% if form.disponible.errors %}<span class="error">{{ form.disponible.errors|join:", " }}</span>{% endif %}
          </div>

        </div>
      </div>
    </div>

    <!-- ‚ë§ Fichiers multim√©dias -->
    <div class="form-section" style="animation-delay: 320ms">
      <div class="section-header">
        <div class="section-num">V</div>
        <div>
          <h2>Fichiers multim√©dias</h2>
          <p>Couverture et version num√©rique PDF</p>
        </div>
      </div>
      <div class="section-body">
        <div class="fields-grid">

          <!-- Couverture -->
          <div class="field-group">
            <label>Image de couverture</label>
            <div class="upload-area">
              <div class="up-icon">üñº</div>
              <p>{{ form.couverture.help_text }}</p>
              {{ form.couverture }}
            </div>
            {% if form.couverture.errors %}<span class="error">{{ form.couverture.errors|join:", " }}</span>{% endif %}

            <div class="cover-preview" id="coverPreview">
              <img id="previewImg" src="" alt="Aper√ßu">
              <p>Aper√ßu de la nouvelle couverture</p>
            </div>

            {% if livre and livre.couverture %}
            <div class="current-cover">
              <img src="{{ livre.couverture.url }}" alt="{{ livre.titre }}">
              <p>Couverture actuelle</p>
            </div>
            {% endif %}
          </div>

          <!-- PDF -->
          <div class="field-group">
            <label>Version num√©rique (PDF)</label>
            <div class="upload-area">
              <div class="up-icon">üìÑ</div>
              <p>{{ form.version_numerique.help_text }}</p>
              {{ form.version_numerique }}
            </div>
            {% if form.version_numerique.errors %}<span class="error">{{ form.version_numerique.errors|join:", " }}</span>{% endif %}

            {% if livre and livre.version_numerique %}
            <div class="pdf-existing">
              <span>üìÑ</span>
              Fichier actuel :
              <a href="{{ livre.version_numerique.url }}" target="_blank">T√©l√©charger ‚Üó</a>
            </div>
            {% endif %}
          </div>

        </div>
      </div>
    </div>

    <div class="ornament">‚ú¶ ‚ú¶ ‚ú¶</div>

    <!-- Actions -->
    <div class="form-actions">
      <button type="submit" class="btn btn-primary">
        {% if action == 'Modifier' %}Enregistrer les modifications ‚Üí{% else %}Cr√©er le livre ‚Üí{% endif %}
      </button>
      <a href="{% url 'livre_list' %}" class="btn btn-secondary" id="cancelBtn">‚Üê Annuler</a>
      {% if livre %}
        <a href="{% url 'livre_detail' livre.pk %}" class="btn btn-view">üëÅ Voir le livre</a>
      {% endif %}
    </div>

  </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // ‚îÄ‚îÄ Compteur titre ‚îÄ‚îÄ
  const titreInput   = document.getElementById('{{ form.titre.id_for_label }}');
  const titreCounter = document.getElementById('titreCounter');
  if (titreInput && titreCounter) {
    titreInput.addEventListener('input', function() {
      const n = this.value.length;
      titreCounter.textContent = n + ' / 300 caract√®res';
      titreCounter.className = 'char-counter' + (n > 300 ? ' warn' : '');
    });
    titreInput.dispatchEvent(new Event('input'));
  }

  // ‚îÄ‚îÄ Compteur r√©sum√© ‚îÄ‚îÄ
  const resumeInput   = document.getElementById('{{ form.resume.id_for_label }}');
  const resumeCounter = document.getElementById('resumeCounter');
  if (resumeInput && resumeCounter) {
    resumeInput.addEventListener('input', function() {
      resumeCounter.textContent = this.value.length + ' caract√®res';
    });
    resumeInput.dispatchEvent(new Event('input'));
  }

  // ‚îÄ‚îÄ Pr√©visualisation couverture ‚îÄ‚îÄ
  const couvertureInput = document.getElementById('{{ form.couverture.id_for_label }}');
  const coverPreview    = document.getElementById('coverPreview');
  const previewImg      = document.getElementById('previewImg');
  if (couvertureInput) {
    couvertureInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = e => {
          previewImg.src = e.target.result;
          coverPreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        coverPreview.style.display = 'none';
      }
    });
  }

  // ‚îÄ‚îÄ Validation c√¥t√© client ‚îÄ‚îÄ
  const livreForm = document.getElementById('livreForm');
  livreForm.addEventListener('submit', function(e) {
    let valid = true;
    this.querySelectorAll('input[required], select[required], textarea[required]').forEach(f => {
      if (!f.value.trim()) {
        f.classList.add('error-field');
        valid = false;
      } else {
        f.classList.remove('error-field');
      }
    });
    if (!valid) {
      e.preventDefault();
      const first = this.querySelector('.error-field');
      if (first) { first.scrollIntoView({ behavior: 'smooth', block: 'center' }); first.focus(); }
    }
  });
  livreForm.querySelectorAll('input, select, textarea').forEach(f => {
    f.addEventListener('input', () => f.classList.remove('error-field'));
  });

  // ‚îÄ‚îÄ Alerte quitter sans sauvegarder ‚îÄ‚îÄ
  let formModified = false;
  livreForm.addEventListener('input', () => { formModified = true; });
  document.getElementById('cancelBtn')?.addEventListener('click', function(e) {
    if (formModified && !confirm('Des modifications ne sont pas enregistr√©es. Quitter quand m√™me ?')) {
      e.preventDefault();
    }
  });
</script>
{% endblock %}