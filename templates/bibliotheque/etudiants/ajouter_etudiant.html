{% extends 'bibliotheque/base.html' %}
{% load static %}

{% block title %}Ajouter un étudiant{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <!-- En-tête -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-user-plus"></i> Ajouter un étudiant</h2>
                <a href="{% url 'liste_etudiants' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Retour à la liste
                </a>
            </div>

            <!-- Messages d'erreur globaux -->
            {% if form.non_field_errors %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ form.non_field_errors }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            {% endif %}

            <!-- Formulaire -->
            <form method="post" id="etudiantForm" novalidate>
                {% csrf_token %}

                <!-- Section Informations personnelles -->
                <div class="form-section">
                    <h4><i class="fas fa-user"></i> Informations personnelles</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.matricule.id_for_label }}" class="required-field">
                                    {{ form.matricule.label }}
                                </label>
                                {{ form.matricule }}
                                {% if form.matricule.errors %}
                                    <div class="error-message">{{ form.matricule.errors.0 }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Le matricule doit être unique</small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.email.id_for_label }}" class="required-field">
                                    {{ form.email.label }}
                                </label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div class="error-message">{{ form.email.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.nom.id_for_label }}" class="required-field">
                                    {{ form.nom.label }}
                                </label>
                                {{ form.nom }}
                                {% if form.nom.errors %}
                                    <div class="error-message">{{ form.nom.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.prenom.id_for_label }}" class="required-field">
                                    {{ form.prenom.label }}
                                </label>
                                {{ form.prenom }}
                                {% if form.prenom.errors %}
                                    <div class="error-message">{{ form.prenom.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.sexe.id_for_label }}">
                                    {{ form.sexe.label }}
                                </label>
                                {{ form.sexe }}
                                {% if form.sexe.errors %}
                                    <div class="error-message">{{ form.sexe.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.date_naissance.id_for_label }}">
                                    {{ form.date_naissance.label }}
                                </label>
                                {{ form.date_naissance }}
                                {% if form.date_naissance.errors %}
                                    <div class="error-message">{{ form.date_naissance.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.lieu_naissance.id_for_label }}">
                                    {{ form.lieu_naissance.label }}
                                </label>
                                {{ form.lieu_naissance }}
                                {% if form.lieu_naissance.errors %}
                                    <div class="error-message">{{ form.lieu_naissance.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.telephone.id_for_label }}">
                                    {{ form.telephone.label }}
                                </label>
                                {{ form.telephone }}
                                {% if form.telephone.errors %}
                                    <div class="error-message">{{ form.telephone.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.adresse.id_for_label }}">
                                    {{ form.adresse.label }}
                                </label>
                                {{ form.adresse }}
                                {% if form.adresse.errors %}
                                    <div class="error-message">{{ form.adresse.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Informations académiques -->
                <div class="form-section">
                    <h4><i class="fas fa-graduation-cap"></i> Informations académiques</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.universite.id_for_label }}" class="required-field">
                                    {{ form.universite.label }}
                                </label>
                                {{ form.universite }}
                                {% if form.universite.errors %}
                                    <div class="error-message">{{ form.universite.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.faculte.id_for_label }}" class="required-field">
                                    {{ form.faculte.label }}
                                </label>
                                {{ form.faculte }}
                                {% if form.faculte.errors %}
                                    <div class="error-message">{{ form.faculte.errors.0 }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Sélectionnez d'abord une université</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.departement.id_for_label }}" class="required-field">
                                    {{ form.departement.label }}
                                </label>
                                {{ form.departement }}
                                {% if form.departement.errors %}
                                    <div class="error-message">{{ form.departement.errors.0 }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Sélectionnez d'abord une faculté</small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.classe.id_for_label }}" class="required-field">
                                    {{ form.classe.label }}
                                </label>
                                {{ form.classe }}
                                {% if form.classe.errors %}
                                    <div class="error-message">{{ form.classe.errors.0 }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Sélectionnez d'abord un département</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.niveau_etude.id_for_label }}">
                                    {{ form.niveau_etude.label }}
                                </label>
                                {{ form.niveau_etude }}
                                {% if form.niveau_etude.errors %}
                                    <div class="error-message">{{ form.niveau_etude.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.annee_academique.id_for_label }}">
                                    {{ form.annee_academique.label }}
                                </label>
                                {{ form.annee_academique }}
                                {% if form.annee_academique.errors %}
                                    <div class="error-message">{{ form.annee_academique.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.statut.id_for_label }}">
                                    {{ form.statut.label }}
                                </label>
                                {{ form.statut }}
                                {% if form.statut.errors %}
                                    <div class="error-message">{{ form.statut.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div class="form-group text-right">
                    <a href="{% url 'liste_etudiants' %}" class="btn btn-secondary btn-back">
                        <i class="fas fa-times"></i> Annuler
                    </a>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Fonction pour charger les facultés en fonction de l'université sélectionnée
    $('#id_universite').change(function() {
        var universiteId = $(this).val();
        
        // Réinitialiser les selects dépendants
        $('#id_faculte').html('<option value="">-- Sélectionner une faculté --</option>');
        $('#id_departement').html('<option value="">-- Sélectionner un département --</option>');
        $('#id_classe').html('<option value="">-- Sélectionner une classe --</option>');
        
        if (universiteId) {
            $.ajax({
                url: '{% url "get_facultes" %}',
                data: {
                    'universite_id': universiteId
                },
                dataType: 'json',
                success: function(data) {
                    $.each(data, function(key, value) {
                        $('#id_faculte').append($('<option></option>')
                            .attr('value', value.id)
                            .text(value.nom));
                    });
                }
            });
        }
    });

    // Fonction pour charger les départements en fonction de la faculté sélectionnée
    $('#id_faculte').change(function() {
        var faculteId = $(this).val();
        
        // Réinitialiser les selects dépendants
        $('#id_departement').html('<option value="">-- Sélectionner un département --</option>');
        $('#id_classe').html('<option value="">-- Sélectionner une classe --</option>');
        
        if (faculteId) {
            $.ajax({
                url: '{% url "get_departements" %}',
                data: {
                    'faculte_id': faculteId
                },
                dataType: 'json',
                success: function(data) {
                    $.each(data, function(key, value) {
                        $('#id_departement').append($('<option></option>')
                            .attr('value', value.id)
                            .text(value.nom));
                    });
                }
            });
        }
    });

    // Fonction pour charger les classes en fonction du département sélectionné
    $('#id_departement').change(function() {
        var departementId = $(this).val();
        
        // Réinitialiser le select des classes
        $('#id_classe').html('<option value="">-- Sélectionner une classe --</option>');
        
        if (departementId) {
            $.ajax({
                url: '{% url "get_classes" %}',
                data: {
                    'departement_id': departementId
                },
                dataType: 'json',
                success: function(data) {
                    $.each(data, function(key, value) {
                        $('#id_classe').append($('<option></option>')
                            .attr('value', value.id)
                            .text(value.nom));
                    });
                }
            });
        }
    });

    // Validation du formulaire avant soumission
    $('#etudiantForm').submit(function(e) {
        var isValid = true;
        var requiredFields = ['numero_etudiant', 'nom', 'prenom', 'email', 'universite', 'faculte', 'departement', 'classe'];
        
        // Vérifier les champs obligatoires
        requiredFields.forEach(function(field) {
            var fieldValue = $('#id_' + field).val();
            if (!fieldValue || fieldValue === '') {
                isValid = false;
                $('#id_' + field).addClass('is-invalid');
            } else {
                $('#id_' + field).removeClass('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('Veuillez remplir tous les champs obligatoires (marqués avec *)');
            return false;
        }
        
        // Désactiver le bouton pour éviter les double-soumissions
        $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Enregistrement...');
    });

    // Retirer la classe d'erreur lors de la saisie
    $('input, select, textarea').on('change keyup', function() {
        $(this).removeClass('is-invalid');
    });
});
</script>
{% endblock %}